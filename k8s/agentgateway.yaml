apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: agentgateway
  namespace: siesta
spec:
  gatewayClassName: enterprise-agentgateway
  listeners:
  - name: https
    port: 443
    protocol: HTTPS
    tls:
      mode: Terminate
      certificateRefs:
      - kind: Secret
        name: siesta-tls
    allowedRoutes:
      namespaces:
        from: Same
  - name: mcp-https
    port: 3000
    protocol: HTTPS
    tls:
      mode: Terminate
      certificateRefs:
      - kind: Secret
        name: siesta-tls
    allowedRoutes:
      namespaces:
        from: Same
  - name: mcp-http
    port: 3001
    protocol: HTTP
    allowedRoutes:
      namespaces:
        from: Same
  - name: support-mcp
    port: 3002
    protocol: HTTP
    allowedRoutes:
      namespaces:
        from: Same
  - name: postgres
    port: 5432
    protocol: TCP
    allowedRoutes:
      namespaces:
        from: Same
      kinds:
      - kind: TCPRoute
        group: gateway.networking.k8s.io
  - name: redis
    port: 6379
    protocol: TCP
    allowedRoutes:
      namespaces:
        from: Same
      kinds:
      - kind: TCPRoute
        group: gateway.networking.k8s.io
  - name: otel-traces
    port: 4317
    protocol: TCP
    allowedRoutes:
      namespaces:
        from: Same
      kinds:
      - kind: TCPRoute
        group: gateway.networking.k8s.io
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: portfolio-analyzer
  namespace: siesta
spec:
  mcp:
    targets:
    - name: portfolio-analyzer
      static:
        host: mcp.cs.solo.io
        port: 443
        path: /mcp
        protocol: StreamableHTTP
        policies:
          auth:
            passthrough: {}
          tls: {}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: portfolio-analyzer
  namespace: siesta
spec:
  parentRefs:
  - name: agentgateway
    sectionName: mcp-https
  - name: agentgateway
    sectionName: mcp-http
  rules:
  - backendRefs:
    - group: agentgateway.dev
      kind: AgentgatewayBackend
      name: portfolio-analyzer
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: siesta-web
  namespace: siesta
spec:
  parentRefs:
  - name: agentgateway
    sectionName: https
  hostnames:
  - siesta.cjett.net
  rules:
  - backendRefs:
    - kind: Service
      name: siesta
      port: 80
    matches:
    - path:
        type: PathPrefix
        value: /
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: openai
  namespace: siesta
spec:
  ai:
    groups:
    - providers:
      - name: openai
        openai: {}
        host: api.openai.com
        port: 443
        policies:
          auth:
            passthrough: {}
          tls: {}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: openai-proxy
  namespace: siesta
spec:
  parentRefs:
  - name: agentgateway
    sectionName: mcp-http
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /v1
    backendRefs:
    - group: agentgateway.dev
      kind: AgentgatewayBackend
      name: openai
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayBackend
metadata:
  name: support-agent-tools
  namespace: siesta
spec:
  mcp:
    targets:
    - name: support-agent-tools
      static:
        host: support-agent-tools.is.solo.io
        port: 443
        path: /mcp
        protocol: StreamableHTTP
        policies:
          auth:
            passthrough: {}
          tls: {}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: support-agent-tools
  namespace: siesta
spec:
  parentRefs:
  - name: agentgateway
    sectionName: support-mcp
  rules:
  - backendRefs:
    - group: agentgateway.dev
      kind: AgentgatewayBackend
      name: support-agent-tools
---
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TCPRoute
metadata:
  name: postgres
  namespace: siesta
spec:
  parentRefs:
  - name: agentgateway
    sectionName: postgres
  rules:
  - backendRefs:
    - name: postgres-cnpg-rw
      port: 5432
---
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TCPRoute
metadata:
  name: redis
  namespace: siesta
spec:
  parentRefs:
  - name: agentgateway
    sectionName: redis
  rules:
  - backendRefs:
    - name: redis
      port: 6379
---
apiVersion: v1
kind: Service
metadata:
  name: otel-collector-traces
  namespace: siesta
spec:
  type: ExternalName
  externalName: opentelemetry-collector-traces.telemetry.svc.cluster.local
---
apiVersion: gateway.networking.k8s.io/v1alpha2
kind: TCPRoute
metadata:
  name: otel-traces
  namespace: siesta
spec:
  parentRefs:
  - name: agentgateway
    sectionName: otel-traces
  rules:
  - backendRefs:
    - name: otel-collector-traces
      port: 4317
---
apiVersion: agentgateway.dev/v1alpha1
kind: AgentgatewayPolicy
metadata:
  name: siesta-auth
  namespace: siesta
spec:
  targetRefs:
  - group: gateway.networking.k8s.io
    kind: Gateway
    name: agentgateway
    sectionName: mcp-https
  traffic:
    apiKeyAuthentication:
      mode: Strict
      secretRef:
        name: siesta-agw-apikey
